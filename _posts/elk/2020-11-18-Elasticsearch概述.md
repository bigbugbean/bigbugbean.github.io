---
title: Elasticsearch概述
tags: Elasticsearch elk
typora-copy-images-to: ..\..\assets\blog_img
typora-root-url: ..\..
---

## 简介

Elasticsearch简称ES，是一个分布式搜索和分析引擎，是Elastic Stack的核心。在Elastic Stack中，Logstash或Beats负责收集和聚合数据，然后存储在Elasticsearch中；Kibana则负责数据的可视化；Elasticsearch负责对数据建立索引，提供搜索、分析功能。

ES最大的亮点是搜索和分析是近实时的(1s内)，而且可以针对所有的数据类型，如：结构化和非结构化文档、数字、地理信息数据等。除了简单的搜索之外，你还能通过ES来发现数据的趋势和模式；随着数据和查询量的增长，ES的分布式特性使你的部署能够与之同步无缝增长。

## 应用场景

[ES官方文档](https://www.elastic.co/guide/en/elasticsearch/reference/current/elasticsearch-intro.html)介绍了ES在处理数据方面有着广泛的应用场景：

- 在应用程序或网站上添加一个搜索框
- 存储和分析日志、指标和安全事件数据
- 利用机器学习自动为数据的行为实时建模
- 作为存储引擎自动化业务工作流
- 作为地理信息系统(GIS)管理、集成和分析空间信息
- 作为生物信息学研究工具存储和处理遗传数据

## 原理

和传统的关系型数据库不同，ES不是将信息存储为柱状数据的行，而是JSON文档。当数据作为JSON文档被存储起来后，它会被编入索引，并且可以对其进行[近实时](./2020-11-18-近实时搜索原理.md)的完全搜索。

凭什么那么快？ES采用了一种名为[倒排索引](./2020-11-18-倒排索引原理.md)的数据结构，它支持非常快速的全文搜索。倒排索引简而言之就是将所有文档出现的每个词都列出来，并且标识它们都在哪些文档中出现过，如果搜索的关键字是这些词中的一个，那么就能快速定位到具体的文档。

## 无模式(schema-less)

无模式通俗的讲就是，创建一个索引时，无需明确指定有什么字段和字段的数据类型，当动态映射启用时，ES会自动检测出新字段的数据类型——如布尔值、浮点值和整数值、日期和字符串，并映射到适当的ES数据类型，然后将新的字段加入索引中。

当然，你比ES更了解如何使用数据，你可以定义规则来控制动态映射，也可以显式定义映射来完全控制字段的存储和索引方式。

定义自己的映射你能够：

- 区分全文字符串字段和精确值字符串字段
- 执行特定语言的文本分析
- 优化部分匹配的字段
- 使用自定义日期格式
- 使用无法自动检测的geo_point和geo_shape等数据类型

## 搜索

ES提供简单、清晰的REST API用于搜索数据（还可以用来管理集群、索引），并支持结构化查询、全文检索和结合两者的复合查询。结构化查询就是类似于利用SQL构建的查询；而全文检索会搜索与关键字匹配的所有文档，而且返回的结果会根据相关性排序。

除了搜索特定项之外，还可以执行短语搜索、相似性搜索和前缀搜索，并获得自动完成建议。ES还会以优化的数据结构索引非文本数据，支持高性能地理和数值查询。

ES支持两种风格的查询语言，全面json风格的查询语言[DSL](https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html)和传统的 [SQL](https://www.elastic.co/guide/en/elasticsearch/reference/current/sql-overview.html)。

## 分析

ES aggregations使您能够构建复杂的数据总结报告，并获得对关键指标、模式和趋势的洞察。与“大海捞针”相比，aggregations可以让你回答以下问题：

- 大海里有多少根针?
- 针的平均长度是多少?
- 针长度的中位数是多少？按照厂家分类，每个厂家制造了多少根?
- 在过去的六个月里，每一个月都在大海里放了多少根针?

甚至你还可以利用aggregations帮助你回答以下更精妙的问题：

- 最受欢迎的针具制造商是什么？
- 是否有不正常或不规则的针丛?

因为aggregations利用了用于搜索的相同数据结构，所以它们也非常快。这使你能够实时分析和可视化您的数据。更重要的是，聚合随着搜索请求一起执行，你可以在一个请求中对相同的数据同时搜索文档、过滤结果和执行分析。

还有，你可以使用[machine learning](https://www.elastic.co/guide/en/machine-learning/7.10/ml-overview.html)特性来创建数据中正常行为的精确基准，并识别异常模式。通过机器学习，你可以检测：

- 与数值、计数或频率的时间偏差相关的异常
- 统计稀有度
- 人口成员的异常行为

## 伸缩性

ES具有高可用和可伸缩性，会自动在所有可用节点之间分配数据和查询负载。原理是ES的索引数据是分布在一个或多个分片上的，这些分片分布在一个或多个节点上，随着集群的增长（或收缩），ES会自动迁移分片以重新平衡集群。

分片有两种类型：主分片和副本分片。索引中的每个文档都属于一个主分片。副本分片是主分片的复制。创建索引时，索引中主碎片的数量是固定的，但是副本碎片的数量可以随时更改，而不会中断索引或查询操作。

如何确定分片的大小和数量呢？这是一个技术活，存在许多性能方面的考虑和权衡取舍。分片越多，维护这些索引的开销就越大。分片大小越大，当ES需要重新平衡集群时，分片移动所需的时间就越长；查询很多小的分片会使每个分片的处理速度更快，但是更多的查询意味着更多的开销，查询大分片的处理速度显然会更慢，但是查询更少开销也会更少，总体的开销视查询数量和单个分片查询时间而定。确定分片的大小和数量没有银弹，不过在刚开始建立索引时可以遵循以下准则：

- 平均分片大小保持在几GB到几十GB之间
- 避免分片过多，节点可以容纳的分片数量与可用堆空间成比例。通常，每GB堆空间中的分片数量应少于20。

想要确定最佳的配置方案，还是要通过[使用自己的数据进行测试](https://www.elastic.co/cn/elasticon/conf/2016/sf/quantitative-cluster-sizing)。

## 容灾

出于性能考虑，群集内的节点必须位于同一网络上。集群中的节点如果是跨不同数据中心，那么在平衡集群中的分片时会花费很长时间。但是高可用性架构要求你不要将所有鸡蛋都放在一个篮子里。如果一个位置发生重大故障，则另一个位置的服务器需要能够无缝接管。跨集群复制（CCR）可以实现。

CCR可以自动将索引从主群集同步到可以用作热备份的辅助远程群集。如果主群集发生故障，则辅助群集可以接管。CCR采用读写分离的方案，所有的写请求只能由主集群处理，辅助集群只能处理读请求。

## 维护

你可以将[Kibana](https://www.elastic.co/guide/en/kibana/7.10/introduction.html)用作控制中心来管理集群，包含了特征[数据汇总](https://www.elastic.co/guide/en/elasticsearch/reference/current/rollup-overview.html)和[指标生命周期管理](https://www.elastic.co/guide/en/elasticsearch/reference/current/index-lifecycle-management.html)功能。

